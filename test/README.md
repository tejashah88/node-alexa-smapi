# About the node-alexa-smapi test suite
This test suite will perform the following actions:
- Retrieve a valid access_token and keep it for use in all SMAPI invocations.
- List all vendors and use the first vendor (account) in the list to create a test skill.
- Invoke all SMAPI operations against this test skill and retry failed invocations as many as (test configuration flag) `MAX_RETRIES` times.
- Will sleep before retries when receiving a `429` rate limiting status.
- If test configuration `TEST_CERTIFICATION` flag is set:
  - Submit skill for certification. **The owner of the vendor (account) should expect a certification submission email from Amazon and may receive a certification feedback on as well ;-)**
  - Withdraw skill from certification
- Remove the test skill after all SMAPI testing is complete.
- If a test run fails, you may need to **manually clean up the test skill** created during the failed test run. **This may include withdrawing it from certification.**

# About the test skill created by this test suite
By default the test skill created will have:
- Name: node-alexa-smapi test skill
- Logo: a bug over a blue background [see it here](https://s3.amazonaws.com/node-alexa-smapi/icons/icon_512_A2Z.png).
- These default values may be changed in the manifest files under test/data

# node-alexa-smapi test suite requirements
Please follow the steps below in order to successfully run this test suite:
- First obtain refreshToken, clientId, and clientSecret
  - Follow [these instructions](https://developer.amazon.com/docs/smapi/ask-cli-command-reference.html#util-command) to retrieve clientId and clientSecret.
  - Run `ask util generate-lwa-tokens` to generate a refreshToken (copy the value from refresh_token and use it to initialize refreshToken in the next step).
- Then create and populate the file test/data/secrets.json with the following information:
  - refreshToken (starts with "Atzr|")
  - clientId
  - clientSecret

Sample `test/data/secrets.json`:
```
{
	"refreshToken": "generated by ask util generate-lwa-tokens",
	"clientId": "amzn1.application-oa2-client.myClientId",
	"clientSecret": "myClientSecret"
}

```

# Travis CI build requirements
Add the following environment variables to your Travis CI repository settings::
- CLIENT_ID - clientId from your `test/data/secrets.json` within quotes to correctly bash-escape it.
- CLIENT_SECRET - clientSecret from your `test/data/secrets.json`.
- REFRESH_TOKEN - refreshToken from your `test/data/secrets.json` within quotes to correctly bash-escape it.
- TEST_CERTIFICATION - flag to indicate if certification should be run or not. If not defined, it will be set to false.

# Test configuration options
Due to the asynchronous nature of this test suite, you may need to adjust one of the following configuration parameters so the test suite complete successfully.

```javascript
const LOG_RESPONSES = false; // if true will output (console.log) the response received by each SMAPI operation
const LOG_ERRORS = true; // if true will output (console.log) any unexpected response received from SMAPI
const MAX_RETRIES = 10; // number of times the test suite will check for completion of create/update operations before proceeding with other test cases
const RETRY_TIMEOUT = 10000; // time (in milliseconds) to wait before checking again for completion of create/update operations
const WITHDRAWAL_TIMEOUT = 1 * 60 * 1000; // time (in milliseconds) to wait before withdrawing skill from certification
const MOCHA_TIMEOUT = WITHDRAWAL_TIMEOUT + 10000; // for details see https://mochajs.org/#timeouts
const TEST_CERTIFICATION = true; // if true will run the Skill Certification test cases (adds a tens of minutes to this test run)
```
